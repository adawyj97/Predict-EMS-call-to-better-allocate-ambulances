---
title: "Modeling"
author: "Yujing Wu"
date: "12/3/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyr)
library(tidyverse)
library(sf)
library(RSocrata)
library(lubridate)
library(tigris)
library(tidycensus)
library(gganimate)
library(viridis)
library(riem)
library(gridExtra)
library(knitr)
library(kableExtra)
#library(stargazer)

mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2)
  )
}

plotTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle = element_text(face="italic"),
    plot.caption = element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.background = element_rect(fill = "grey80", color = "white"),
    strip.text = element_text(size=12),
    axis.title = element_text(size=12),
    axis.text = element_text(size=10),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"),
    strip.text.x = element_text(size = 14)
  )
}

palette5 <- c("#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c")
palette4 <- c("#D2FBD4","#92BCAB","#527D82","#123F5A")
palette3 <- c("#6baed6","#3182bd","#08519c")
palette2 <- c("#6baed6","#08519c")

qBr <- function(df, variable, rnd) {
  if (missing(rnd)) {
    as.character(quantile(round(df[[variable]],0),
                          c(.01,.2,.4,.6,.8), na.rm=T))
  } else if (rnd == FALSE | rnd == F) {
    as.character(formatC(quantile(df[[variable]]), digits = 3),
                          c(.01,.2,.4,.6,.8), na.rm=T)
  }
}

q5 <- function(variable) {as.factor(ntile(variable, 5))}
```

```{r}
EMS_Call.Train <- filter(EMS_Call_final, week < 28)
EMS_Call.Test <- filter(EMS_Call_final, week >= 28)
```

```{r}
regression1 <-
    glm(Call_Count ~ hour(interval60) + dotw + Temperature, family = "poisson", 
      data = EMS_Call.Train)
```

```{r}
regression2 <- 
  glm(Call_Count ~  GEOID + dotw + Temperature, family = "poisson", data = EMS_Call.Train)
```

```{r}
regression3 <- 
  glm(Call_Count ~  GEOID + hour(interval60) + dotw + Temperature, 
     family = "poisson", data = EMS_Call.Train)
```

```{r}
regression4 <- 
  glm(Call_Count ~  GEOID +  hour(interval60) + dotw + Temperature +
                   lagHour + lag2Hours +lag3Hours + lag12Hours + lag1day, 
     family = "poisson",
     data = EMS_Call.Train)
```

```{r}
regression5 <- 
  glm(Call_Count ~  GEOID + hour(interval60) + dotw + Temperature + Percipitation +
                   lagHour + lag2Hours +lag3Hours +lag12Hours + lag1day,
     family = "poisson",
     data = EMS_Call.Train)
```

```{r}
EMS_Call.Test.weekNest <- 
  EMS_Call.Test %>%
  nest(-week) 

EMS_Call.Test.weekNest
```
```{r}
model_pred <- function(dat, fit){
   pred <- predict(fit, newdata = dat)}
```

```{r}
week_predictions <- 
  EMS_Call.Test.weekNest %>% 
    mutate(A_Time_FE = map(.x = data, fit = regression1, .f = model_pred),
           B_Space_FE = map(.x = data, fit = regression2, .f = model_pred),
           C_Time_Space_FE = map(.x = data, fit = regression3, .f = model_pred),
           D_Time_Space_FE_timeLags = map(.x = data, fit = regression4, .f = model_pred),
           E_Time_Space_FE_timeLags_holidayLags = map(.x = data, fit = regression5, .f = model_pred))

week_predictions 
```

```{r}
week_predictions <-
  week_predictions %>% 
    gather(Regression, Prediction, -data, -week) %>%
    mutate(Observed = map(data, pull, Call_Count),
           Absolute_Error = map2(Observed, Prediction,  ~ abs(.x - .y)),
           MAE = map_dbl(Absolute_Error, mean),
           sd_AE = map_dbl(Absolute_Error, sd))

week_predictions 
```

```{r}
EMS_Call.Test.weekNest %>%
  mutate(Call_Count = map(data, pull, Call_Count),
         Mean_Call_Count = map_dbl(Call_Count, mean))
```


