---
title: "Data_Wrangling"
author: "Yujing Wu"
date: "11/23/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(sf)
library(RSocrata)
library(lubridate)
library(tigris)
library(tidycensus)
library(gganimate)
library(viridis)
library(riem)
library(gridExtra)
library(knitr)
library(kableExtra)
#library(stargazer)

mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2)
  )
}

plotTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle = element_text(face="italic"),
    plot.caption = element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.background = element_rect(fill = "grey80", color = "white"),
    strip.text = element_text(size=12),
    axis.title = element_text(size=12),
    axis.text = element_text(size=10),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"),
    strip.text.x = element_text(size = 14)
  )
}

palette5 <- c("#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c")
palette4 <- c("#D2FBD4","#92BCAB","#527D82","#123F5A")
palette3 <- c("#6baed6","#3182bd","#08519c")
palette2 <- c("#6baed6","#08519c")

qBr <- function(df, variable, rnd) {
  if (missing(rnd)) {
    as.character(quantile(round(df[[variable]],0),
                          c(.01,.2,.4,.6,.8), na.rm=T))
  } else if (rnd == FALSE | rnd == F) {
    as.character(formatC(quantile(df[[variable]]), digits = 3),
                          c(.01,.2,.4,.6,.8), na.rm=T)
  }
}

q5 <- function(variable) {as.factor(ntile(variable, 5))}
```

```{r}
boundary <- st_read('https://opendata.arcgis.com/datasets/759ad66064974eab9a556d3a90efa1a1_19.geojson') %>%
  st_set_crs(4326) %>%
   st_transform(2284)
```

```{r}
fishnet <- 
  st_make_grid(boundary, cellsize = 5000) %>%
  st_sf()

fishnet <- 
  fishnet[boundary,] %>%
  mutate(uniqueID = rownames(.)) %>%
  dplyr::select(uniqueID)
```

```{r}
ggplot() + 
  geom_sf(data=fishnet) +
  labs(title = "Virginia Beach fishnet") +
  mapTheme()
```

```{r}
EMS_calls <- read.socrata("https://data.vbgov.com/Public-Safety/EMS-Calls-For-Service/2wub-c2dx") %>%
  mutate(year = substr(call_date_and_time,1,4)) %>%
  filter(year == "2017") %>%
  mutate(x = gsub("^.*\\(\\s*", "", location_1)) %>%
  mutate(x = gsub("[)]", "", x)) %>%
  mutate(x = gsub("[a-zA-Z]", "", x)) %>%
  separate(x, c("Y","X"), sep=",") %>%
  mutate(X = as.numeric(X),
          Y = as.numeric(Y)) %>% 
   na.omit %>%
   st_as_sf(coords = c("X", "Y"), crs = 4326) %>%
   st_transform(2284)
```

```{r}
weather.Data <- 
  riem_measures(station = "NTU", date_start = "2017-01-01", date_end = "2018-01-01")
```

```{r}
weather.Panel <-  
  weather.Data %>%
    replace(is.na(.), 0) %>%
    mutate(interval60 = ymd_h(substr(valid,1,13))) %>%
    mutate(week = week(interval60),
           dotw = wday(interval60, label=TRUE)) %>%
    group_by(interval60) %>%
    summarize(Temperature = max(tmpf),
              Percipitation = sum(p01i),
              Wind_Speed = max(sknt)) %>%
    mutate(Temperature = ifelse(Temperature == 0, 42, Temperature))
```

```{r}
EMS_calls2 <-
  EMS_calls %>% 
  mutate(interval60 = floor_date(ymd_hms(call_date_and_time), unit = "hour"),
         interval15 = floor_date(ymd_hms(call_date_and_time), unit = "15 mins"),
         week = week(interval60),
         dotw = wday(interval60, label=TRUE))
```

```{r}
EMS_fishnet <-
  EMS_calls2 %>% 
  st_join(fishnet, st_intersects) %>% 
  st_set_geometry(NULL)
```

```{r}
EMS.template <- 
  EMS_fishnet %>%
  filter(week >= 22 & week <= 24 | week >= 25 & week <= 30)
```

```{r}
study.panel <- 
  expand.grid(interval60 = seq(floor_date(ymd_hms(min(EMS.template$call_date_and_time)), unit = "hour"),floor_date(ymd_hms(max(EMS.template$call_date_and_time)), unit = "hour"), by = '60 mins'), 
              uniqueID = unique(fishnet$uniqueID)) 

nrow(study.panel)   
```

```{r}
EMS_Call.panel <- 
  EMS.template %>%
    mutate(Call_Counter = 1) %>%
    right_join(study.panel) %>% 
      group_by(interval60, uniqueID) %>%
      summarize(Call_Count = sum(Call_Counter, na.rm=T)) %>%
      left_join(weather.Panel) %>%
      left_join(fishnet, by=c("uniqueID")) %>%
            ungroup() %>%                                 
            mutate(week = week(interval60),
                   dotw = wday(interval60, label = TRUE)) %>%
            st_sf()
```

```{r}
EMS_Call.panel <- 
  EMS_Call.panel %>% 
    arrange(uniqueID, interval60) %>% 
    mutate(lagHour = dplyr::lag(Call_Count,1),
           lag2Hours = dplyr::lag(Call_Count,2),
           lag3Hours = dplyr::lag(Call_Count,3),
           lag4Hours = dplyr::lag(Call_Count,4),
           lag12Hours = dplyr::lag(Call_Count,12),
           lag1day = dplyr::lag(Call_Count,24)) %>%
    mutate(day = yday(interval60)) 
```

```{r}
EMS_Call.Train <- filter(EMS_Call.panel, week < 28)
EMS_Call.Test <- filter(EMS_Call.panel, week >= 28)
```

```{r}
Rescue_stations <- st_read('Data\\Rescue_stations.shp') %>%
   st_transform(2284)
```

```{r}
vbCensus <- 
  get_acs(geography = "tract", variables = c("B01003_001", "B19013_001", "B02001_002", "B08013_001",                                                        "B08012_001", "B08301_001", "B08301_010"), 
          year = 2017, state = "VA", geometry = TRUE, county=c("Virginia Beach")) %>%
  mutate(variable = 
          case_when(variable == "B01003_001" ~ "Total_Population",
                    variable == "B19013_001" ~ "Median_Household_Income",
                    variable == "B02001_002" ~ "Total_White_Population",
                    variable == "B08013_001" ~ "Aggregate_Travel_Time_to_Work",
                    variable == "B08012_001" ~ "Sex_of_Workers_by_Travel_Time_to_work",
                    variable == "B08301_001" ~ "Means_of_Transportation_to_Work",
                    variable == "B08301_010" ~ "Total_Public_Trans_excl_Taxi")) %>%
  select(variable, estimate, GEOID, geometry) %>%
  spread(variable,estimate) %>%
  mutate(Percent_White = Total_White_Population / Total_Population,
         Mean_Commute_Time_for_Workers = Aggregate_Travel_Time_to_Work / Sex_of_Workers_by_Travel_Time_to_work,
         Percent_Taking_Public_Trans = Total_Public_Trans_excl_Taxi / Means_of_Transportation_to_Work) %>%
  gather(Variable,Value, -GEOID, -geometry) 
```

```{r}
vbTracts <- 
  vbCensus %>%
  as.data.frame() %>%
  distinct(GEOID, .keep_all = TRUE) %>%
  select(GEOID, geometry) %>% 
  st_sf()
```

```{r, fig.width= 18, fig.height=4}
mondayMidnight <- 
  EMS_Call.panel %>%
  mutate(mondayMidnight = ifelse(wday(interval60) == 2 & hour(interval60) == 1,
                                 as.POSIXct(interval60),0)) %>%
  filter(mondayMidnight != 0) 

  rbind(
    mutate(EMS_Call.Train, label = "Training"), 
    mutate(EMS_Call.Test, label = "Testing")) %>%
      group_by(label, interval60) %>% 
        summarize(Call_Count = sum(Call_Count)) %>%
        ggplot(aes(interval60, Call_Count, colour = label)) + 
          geom_line() +
          ylim(0,20) +
          labs(title="EMS calls in Virginia Beach by week: June through August, 2018",
               subtitle="Monday demarked in black", x="Day", y="Call Counts") +
          plotTheme() + theme(panel.grid.major = element_blank()) +   
          scale_colour_manual(values = palette2) +
            geom_vline(data = mondayMidnight, aes(xintercept = mondayMidnight), colour="black")
```

```{r}
as.data.frame(EMS_Call.panel) %>%
  group_by(week, interval60) %>% 
  summarize(Call_Count = sum(Call_Count)) %>%
    ggplot(aes(interval60,Call_Count)) + 
      geom_line() +
      plotTheme() +
      facet_wrap(~week, scales="free", ncol=3) +
      ylim(0,20) +
      labs(title="EMS Calls in Virginia Beach by week: June to August, 2017",
            x="Day", y="Trip Counts") 
```

```{r, fig.width=15, fig.height=15}
EMS_Call.panel %>% 
  group_by(week, uniqueID) %>%
  summarize(Sum_Call_Count = sum(Call_Count)) %>%
  ggplot() + geom_sf(aes(fill = Sum_Call_Count)) +
    facet_wrap(~week, ncol = 3) +
    scale_fill_viridis() +
    labs(title="Sum of EMS calls by week") +
    mapTheme() + theme(legend.position = "bottom") 
```

```{r}
as.data.frame(EMS_Call.panel) %>%
  group_by(interval60) %>% 
  summarize(Call_Count = sum(Call_Count)) %>%
  left_join(weather.Panel) %>%
  mutate(isPercip = ifelse(Percipitation > 0,"Rain", "None")) %>%
    group_by(week = week(interval60), isPercip) %>%
      summarize(Mean_Call_Count = mean(Call_Count)) %>%
    ggplot(aes(isPercip, Mean_Call_Count)) + 
      geom_bar(stat = "identity") +
      facet_wrap(~week,ncol=9) +
      labs(title="Does ridership vary when it's raining or snowing?",
           subtitle="Mean trip count by week; November through December, 2018",
           x="Percipitation", y="Mean Trip Count") +
      plotTheme() + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
as.data.frame(EMS_Call.panel) %>%
  group_by(interval60) %>% 
  summarize(Call_Count = sum(Call_Count)) %>%
  left_join(weather.Panel) %>%
  mutate(isHot = ifelse(Temperature > 86,"Hot", "None")) %>%
    group_by(week = week(interval60), isHot) %>%
      summarize(Mean_Call_Count = mean(Call_Count)) %>%
    ggplot(aes(isHot, Mean_Call_Count)) + 
      geom_bar(stat = "identity") +
      facet_wrap(~week,ncol=9) +
      labs(title="Does EMS Call vary when it's too hot?",
           subtitle="Mean call count by week; June through August, 2017",
           x="Temperature", y="Mean Call Count") +
      plotTheme() + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
week26 <-
  EMS_fishnet %>%
  filter(week == 26 & dotw == "Mon")

week26.panel <-
  expand.grid(
    interval15=unique(week26$interval15),
      unique(fishnet$uniqueID))
```

```{r}
EMS_Call.animation.data <-
  week26 %>%
    mutate(Call_Counter = 1) %>%
    right_join(week26.panel) %>% 
    group_by(interval60, uniqueID) %>%
    summarize(Call_Count = sum(Call_Counter, na.rm=T)) %>% 
    left_join(fishnet,by=c("uniqueID")) %>%
    st_sf() %>%
    mutate(Calls = case_when(Call_Count == 0 ~ "0 calls",
                             Call_Count > 0 & Call_Count <= 5 ~ "1-5 calls",
                             Call_Count > 5 & Call_Count <= 10 ~ "6-10 calls",
                             Call_Count > 10 & Call_Count <= 20 ~ "11-20 calls",
                             Call_Count > 20 ~ "21+ trips")) %>%
           mutate(Calls  = factor(Calls, levels=c("0 calls","1-5 calls","6-10 calls","11-20 calls","21+ calls")))
```

```{r}
EMS_Call_animation <-
  ggplot() +
  geom_sf(data=EMS_Call.animation.data, aes(fill=Calls)) +
  scale_fill_manual(values = palette5) +
  labs(title = "EMS Calls for one day in June 2018, Virginia Beach",
       subtitle = "60 minute intervals: {current_frame}") +
  transition_manual(interval60) +
  mapTheme()

animate(EMS_Call_animation, duration=20)
```

